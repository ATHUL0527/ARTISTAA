<%- include("../partials/user/header") %>
    <style>
        .cart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .cart-details {
            flex: 1 1 60%;
        }

        .cart-totals-wrapper {
            flex: 1 1 35%;
            max-width: 400px;
            margin-top: 20px;
            margin-left: auto;

        }

        @media (max-width: 768px) {
            .cart-container {
                flex-direction: column;
            }

            .cart-totals-wrapper {
                max-width: 100%;
                margin: 0 auto;
            }
        }
    </style>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Your Cart
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="cart-container">
                    <!-- Cart Details Section -->
                    <div class="cart-details col-12">
                        <div class="table-responsive">
                    
                            <table class="table shopping-summery text-center clean">
                                <thead>
                                    <tr class="main-heading">
                                        <th scope="col">Image</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Price</th>
                                        <th scope="col">Quantity</th>
                                        <th scope="col">Subtotal</th>
                                        <th scope="col">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (cart && cart.items.length> 0) { %>
                                        <% cart.items.forEach(item=> { %>
                                            <tr data-product-id="<%= item.productId._id %>"
                                                data-stock="<%= item.productId.quantity %>">


                                                <td class="image product-thumbnail">
                                                    <img src="/uploads/re-image/<%= item.productId.productImage[0] %>"
                                                        alt="<%= item.productId.productName %>">
                                                </td>
                                                <td class="product-des product-name">
                                                    <h5 class="product-name">
                                                        <a href="/productDetails?id=<%= item.productId._id %>">
                                                            <%= item.productId.productName %>
                                                        </a>
                                                    </h5>
                                                </td>
                                                <td class="price" data-title="Price"><span>₹<%= item.price %></span>
                                                </td>
                                                <td class="text-center" data-title="Quantity">
                                                    <div class="detail-qty border radius m-auto">
                                                        <a href="#" class="qty-down"><i
                                                                class="fi-rs-angle-small-down"></i></a>
                                                        <span class="qty-val">
                                                            <%= item.quantity %>
                                                        </span>
                                                        <a href="#" class="qty-up"><i
                                                                class="fi-rs-angle-small-up"></i></a>
                                                    </div>
                                                </td>
                                                <td class="text-right subtotal" data-title="Subtotal">
                                                    <span>₹<%= item.totalPrice %></span>
                                                </td>
                                                <td class="action" data-title="Remove">
                                                    <button class="text-muted"
                                                        onclick="removeFromCart('<%= item.productId._id %>')">
                                                        <i class="fi-rs-trash"></i>
                                                    </button>
                                                </td>

                                            </tr>
                                            <% }); %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="6" class="text-center">Your cart is empty</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <div class="cart-action text-end">
                            <a href="/cart/clear" class="btn mr-10 mb-sm-15" ><i class="fi-rs-cross-small"></i> Clear
                                Cart</a>
                          
                                <a href="/" class="btn"><i class="fi-rs-shopping-bag mr-10"></i> Continue Shopping</a>
                          
                            
                        </div>
                    </div>

                    <!-- Cart Totals Section -->
                    <div class="cart-totals-wrapper col-lg-6 col-md-12">
                        <div class="border p-md-4 p-30 border-radius cart-totals">
                            <div class="heading_s1 mb-3">
                                <h4>Cart Totals</h4>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td class="cart_total_label">Cart Subtotal</td>
                                            <td class="cart_total_amount">
                                                <span id="cartTotal" class="font-lg fw-900 text-brand">₹<%= cartTotal %>
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label">Shipping</td>
                                            <td class="cart_total_amount"><i class="ti-gift mr-5"></i> Free Shipping
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cart_total_label">Total</td>
                                            <td class="cart_total_amount">
                                                <strong><span id="grandTotal" class="font-xl fw-900 text-brand">₹<%=
                                                            cartTotal %></span></strong>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <% if(cart.items.length){ %>
                            <a href="/checkout" class="btn"><i class="fi-rs-box-alt mr-10"></i> Proceed To Checkout</a>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include("../partials/user/footer") %>

        <script>

            function removeFromCart(productId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/removeCart?productId=${productId}`, {
                            method: 'GET',
                        })
                            .then(response => {
                                if (response.redirected) {
                                    window.location.href = response.url;
                                }
                            })
                            .catch(error => {
                                console.error("Error removing item from cart:", error);
                            });
                    }
                });
            }


            document.addEventListener("DOMContentLoaded", () => {
                const updateCartTotal = () => {
                    const subtotals = document.querySelectorAll(".subtotal span");
                    let cartTotal = 0;

                    subtotals.forEach(subtotal => {
                        cartTotal += parseFloat(subtotal.textContent.replace("₹", ""));
                    });

                    document.getElementById("cartTotal").textContent = `₹${cartTotal.toFixed(2)}`;
                    document.getElementById("grandTotal").textContent = `₹${cartTotal.toFixed(2)}`;
                };

                document.querySelectorAll(".qty-up, .qty-down").forEach(button => {
                    button.addEventListener("click", async event => {
                        event.preventDefault();

                        const isIncrease = event.target.closest(".qty-up");
                        const qtyContainer = button.closest(".detail-qty");
                        const qtyValElement = qtyContainer.querySelector(".qty-val");
                        const row = button.closest("tr");
                        let quantity = parseInt(qtyValElement.innerHTML);
                        const price = parseFloat(row.querySelector(".price span").textContent.replace("₹", ""));
                        const maxStock = parseInt(row.getAttribute("data-stock"));
                        const maxLimit = Math.min(5, maxStock); // Lesser of 5 or stock available
                        const productId = row.getAttribute("data-product-id");

                        // Update quantity based on button clicked
                        if (isIncrease && quantity < maxLimit) {
                            quantity++;
                        } else if (!isIncrease && quantity > 1) {
                            quantity--;
                        }

                        // Set the updated quantity in the UI
                        qtyValElement.textContent = quantity;

                        // Update subtotal
                        const subtotalElement = row.querySelector(".subtotal span");
                        const newSubtotal = price * quantity;
                        subtotalElement.textContent = `₹${newSubtotal.toFixed(2)}`;

                        // Update total
                        updateCartTotal();

                        // Send updated quantity to backend
                        try {
                            await fetch(`/updateQty`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ productId, quantity })
                            });
                        } catch (error) {
                            console.error("Error updating cart:", error);
                        }
                    });
                });
            });


        </script>